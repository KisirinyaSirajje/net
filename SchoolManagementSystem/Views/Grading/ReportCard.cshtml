@model SchoolManagementSystem.Models.Student

@{
    ViewData["Title"] = "Report Card - " + Model.FirstName + " " + Model.LastName;
    var currentYear = ViewBag.CurrentYear?.ToString() ?? DateTime.Now.Year.ToString();
    var currentTerm = ViewBag.CurrentTerm ?? SchoolManagementSystem.Models.Term.Term1;
    var termPerformances = Model.SubjectPerformances.Where(sp => sp.AcademicYear == currentYear && sp.Term == currentTerm).ToList();
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a asp-action="Index">Grading</a></li>
                <li class="breadcrumb-item"><a asp-action="Student" asp-route-id="@Model.Id">@Model.FirstName @Model.LastName</a></li>
                <li class="breadcrumb-item active">Report Card</li>
            </ol>
        </nav>
        <div>
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> Print Report
            </button>
            <a class="btn btn-secondary" asp-action="Student" asp-route-id="@Model.Id">
                <i class="fas fa-arrow-left"></i> Back to Grading
            </a>
        </div>
    </div>

    <!-- Report Card Container -->
    <div class="report-card shadow-lg">
        <!-- Header -->
        <div class="report-header">
            <div class="row align-items-center">
                <div class="col-2 text-center">
                    <div class="school-logo">
                        <i class="fas fa-graduation-cap fa-3x text-primary"></i>
                    </div>
                </div>
                <div class="col-8 text-center">
                    <h2 class="school-name mb-1">UGANDA SECONDARY SCHOOL</h2>
                    <h4 class="report-title mb-1">STUDENT REPORT CARD</h4>
                    <p class="mb-0">
                        Academic Year: <strong>@currentYear</strong> | 
                        @switch(currentTerm)
                        {
                            case SchoolManagementSystem.Models.Term.Term1: @("First Term") break;
                            case SchoolManagementSystem.Models.Term.Term2: @("Second Term") break;
                            case SchoolManagementSystem.Models.Term.Term3: @("Third Term") break;
                            default: @("Term") break;
                        }
                    </p>
                </div>
                <div class="col-2 text-center">
                    <div class="coat-of-arms">
                        <i class="fas fa-shield-alt fa-3x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Information -->
        <div class="student-info">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless table-sm">
                        <tr>
                            <td class="info-label">Student Name:</td>
                            <td class="info-value"><strong>@Model.FirstName @Model.LastName</strong></td>
                        </tr>
                        <tr>
                            <td class="info-label">Index Number:</td>
                            <td class="info-value">@(Model.IndexNumber ?? "N/A")</td>
                        </tr>
                        <tr>
                            <td class="info-label">Class:</td>
                            <td class="info-value">@(Model.CurrentClass ?? "N/A")</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless table-sm">
                        <tr>
                            <td class="info-label">Level:</td>
                            <td class="info-value">
                                @(Model.CurrentLevel == SchoolManagementSystem.Models.EducationLevel.OLevel ? "Ordinary Level (O-Level)" : "Advanced Level (A-Level)")
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">Stream:</td>
                            <td class="info-value">
                                @switch(Model.Stream)
                                {
                                    case SchoolManagementSystem.Models.Stream.Science: @("Science") break;
                                    case SchoolManagementSystem.Models.Stream.Arts: @("Arts") break;
                                    case SchoolManagementSystem.Models.Stream.Business: @("Business Studies") break;
                                    case SchoolManagementSystem.Models.Stream.Technical: @("Technical") break;
                                    default: @("General") break;
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="info-label">Guardian:</td>
                            <td class="info-value">@(Model.GuardianName ?? "N/A")</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Grades Table -->
        <div class="grades-section">
            <h5 class="section-title">
                <i class="fas fa-chart-line"></i> ACADEMIC PERFORMANCE
            </h5>
            
            @if (termPerformances.Any())
            {
                <table class="table table-bordered grades-table">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center" style="width: 5%">#</th>
                            <th style="width: 25%">Subject</th>
                            <th class="text-center" style="width: 10%">Code</th>
                            <th class="text-center" style="width: 15%">Assessment Type</th>
                            <th class="text-center" style="width: 10%">Score (%)</th>
                            <th class="text-center" style="width: 10%">Grade</th>
                            <th class="text-center" style="width: 10%">Points</th>
                            <th style="width: 15%">Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int counter = 1;
                            var groupedPerformances = termPerformances.OrderBy(p => p.Subject.Type).ThenBy(p => p.Subject.Name).ToList();
                        }
                        @foreach (var performance in groupedPerformances)
                        {
                            <tr>
                                <td class="text-center">@counter</td>
                                <td>
                                    <strong>@performance.Subject.Name</strong>
                                    @if (performance.Subject.Type == SchoolManagementSystem.Models.SubjectType.Compulsory)
                                    {
                                        <small class="text-primary">(Core)</small>
                                    }
                                </td>
                                <td class="text-center"><small>@performance.Subject.Code</small></td>
                                <td class="text-center">
                                    <small>
                                        @switch(performance.AssessmentType)
                                        {
                                            case SchoolManagementSystem.Models.AssessmentType.ContinuousAssessment: @("Continuous") break;
                                            case SchoolManagementSystem.Models.AssessmentType.MidtermExam: @("Mid-term") break;
                                            case SchoolManagementSystem.Models.AssessmentType.FinalExam: @("Final") break;
                                            case SchoolManagementSystem.Models.AssessmentType.UCEExam: @("UCE") break;
                                            case SchoolManagementSystem.Models.AssessmentType.UACEExam: @("UACE") break;
                                            default: @("Other") break;
                                        }
                                    </small>
                                </td>
                                <td class="text-center">
                                    @if (performance.Score.HasValue)
                                    {
                                        <strong class="@(GetScoreClass(performance.Score.Value))">@performance.Score.Value.ToString("F1")</strong>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (!string.IsNullOrEmpty(performance.LetterGrade))
                                    {
                                        <span class="grade-badge grade-@performance.LetterGrade.ToLower()">
                                            <strong>@performance.LetterGrade</strong>
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (performance.GradePoint.HasValue)
                                    {
                                        <strong>@performance.GradePoint.Value.ToString("F1")</strong>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (performance.GradeScale != null)
                                    {
                                        <small class="@(performance.GradeScale.IsPassingGrade ? "text-success" : "text-danger")">
                                            @performance.GradeScale.Description
                                        </small>
                                    }
                                    @if (!string.IsNullOrEmpty(performance.Comments))
                                    {
                                        <div><small class="text-muted">@performance.Comments</small></div>
                                    }
                                </td>
                            </tr>
                            counter++;
                        }
                    </tbody>
                </table>

                <!-- Summary Statistics -->
                <div class="summary-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="summary-card bg-primary text-white">
                                <div class="summary-icon">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="summary-content">
                                    <h6>Total Subjects</h6>
                                    <h4>@ViewBag.TotalSubjects</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="summary-card bg-success text-white">
                                <div class="summary-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="summary-content">
                                    <h6>Subjects Passed</h6>
                                    <h4>@ViewBag.PassedSubjects</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="summary-card bg-info text-white">
                                <div class="summary-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="summary-content">
                                    <h6>Average Score</h6>
                                    <h4>@(ViewBag.AverageScore?.ToString("F1") ?? "N/A")%</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="summary-card bg-warning text-white">
                                <div class="summary-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="summary-content">
                                    <h6>Average Grade Points</h6>
                                    <h4>@(ViewBag.AverageGradePoint?.ToString("F1") ?? "N/A")</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No Grades Available</h5>
                    <p class="text-muted">No grades have been recorded for this term yet.</p>
                </div>
            }
        </div>

        <!-- Grading Scale Reference -->
        <div class="grading-scale-section">
            <h6 class="section-title">
                <i class="fas fa-info-circle"></i> 
                @(Model.CurrentLevel == SchoolManagementSystem.Models.EducationLevel.OLevel ? "O-Level" : "A-Level") GRADING SCALE
            </h6>
            <div class="row">
                @if (Model.CurrentLevel == SchoolManagementSystem.Models.EducationLevel.OLevel)
                {
                    <div class="col-md-12">
                        <div class="grading-scale-grid">
                            <div class="grade-item">
                                <span class="grade-badge grade-a">A</span>
                                <span class="grade-range">90-100%</span>
                                <span class="grade-desc">Exceptional</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-b">B</span>
                                <span class="grade-range">80-89%</span>
                                <span class="grade-desc">Outstanding</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-c">C</span>
                                <span class="grade-range">70-79%</span>
                                <span class="grade-desc">Satisfactory</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-d">D</span>
                                <span class="grade-range">60-69%</span>
                                <span class="grade-desc">Basic</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-e">E</span>
                                <span class="grade-range">0-59%</span>
                                <span class="grade-desc">Elementary</span>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="col-md-12">
                        <div class="grading-scale-grid">
                            <div class="grade-item">
                                <span class="grade-badge grade-a">A</span>
                                <span class="grade-range">80-100%</span>
                                <span class="grade-desc">Distinction</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-b">B</span>
                                <span class="grade-range">70-79%</span>
                                <span class="grade-desc">Credit</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-c">C</span>
                                <span class="grade-range">60-69%</span>
                                <span class="grade-desc">Pass</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-d">D</span>
                                <span class="grade-range">50-59%</span>
                                <span class="grade-desc">Weak Pass</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-e">E</span>
                                <span class="grade-range">40-49%</span>
                                <span class="grade-desc">Fail</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-o">O</span>
                                <span class="grade-range">30-39%</span>
                                <span class="grade-desc">Subsidiary</span>
                            </div>
                            <div class="grade-item">
                                <span class="grade-badge grade-f">F</span>
                                <span class="grade-range">0-29%</span>
                                <span class="grade-desc">Fail</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Footer -->
        <div class="report-footer">
            <div class="row">
                <div class="col-md-4">
                    <div class="signature-section">
                        <hr class="signature-line">
                        <p class="signature-label">Class Teacher</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="signature-section">
                        <hr class="signature-line">
                        <p class="signature-label">Head Teacher</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="signature-section">
                        <hr class="signature-line">
                        <p class="signature-label">Parent/Guardian</p>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <small class="text-muted">
                    Report generated on @DateTime.Now.ToString("MMMM dd, yyyy") at @DateTime.Now.ToString("HH:mm")
                </small>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetScoreClass(decimal score)
    {
        if (score >= 90) return "text-success";
        if (score >= 80) return "text-success";
        if (score >= 70) return "text-info";
        if (score >= 60) return "text-warning";
        return "text-danger";
    }
}

<style>
    .report-card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        margin: 0 auto;
        max-width: 900px;
        font-family: 'Times New Roman', serif;
    }

    .report-header {
        border-bottom: 3px solid #007bff;
        padding-bottom: 20px;
        margin-bottom: 25px;
    }

    .school-name {
        color: #007bff;
        font-weight: bold;
        font-size: 1.8rem;
    }

    .report-title {
        color: #6c757d;
        font-weight: bold;
    }

    .student-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
        border-left: 4px solid #007bff;
    }

    .info-label {
        font-weight: bold;
        color: #495057;
        width: 40%;
    }

    .info-value {
        color: #212529;
    }

    .grades-section {
        margin-bottom: 25px;
    }

    .section-title {
        color: #007bff;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 5px;
        border-bottom: 2px solid #dee2e6;
    }

    .grades-table {
        font-size: 0.9rem;
    }

    .grades-table th {
        background: #343a40 !important;
        color: white;
        font-weight: bold;
        text-align: center;
    }

    .grades-table td {
        vertical-align: middle;
    }

    .grade-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-weight: bold;
        color: white;
        min-width: 30px;
        text-align: center;
    }

    .grade-a { background-color: #28a745; }
    .grade-b { background-color: #17a2b8; }
    .grade-c { background-color: #ffc107; color: #212529; }
    .grade-d { background-color: #fd7e14; }
    .grade-e, .grade-f { background-color: #dc3545; }
    .grade-o { background-color: #6f42c1; }

    .summary-section {
        margin-top: 20px;
    }

    .summary-card {
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .summary-icon {
        font-size: 2rem;
        margin-right: 15px;
        opacity: 0.8;
    }

    .summary-content h6 {
        margin-bottom: 5px;
        opacity: 0.9;
    }

    .summary-content h4 {
        margin: 0;
        font-weight: bold;
    }

    .grading-scale-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 25px;
    }

    .grading-scale-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: space-between;
    }

    .grade-item {
        flex: 1;
        min-width: 120px;
        text-align: center;
        padding: 8px;
        background: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }

    .grade-range {
        display: block;
        font-size: 0.85rem;
        color: #6c757d;
        margin: 3px 0;
    }

    .grade-desc {
        display: block;
        font-size: 0.75rem;
        color: #495057;
        font-weight: 500;
    }

    .report-footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
    }

    .signature-section {
        text-align: center;
    }

    .signature-line {
        margin-top: 50px;
        margin-bottom: 5px;
        border: 1px solid #6c757d;
    }

    .signature-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
    }

    @@media print {
        body { font-size: 12px; }
        .report-card { 
            box-shadow: none; 
            padding: 20px;
            max-width: none;
        }
        .btn { display: none !important; }
        .breadcrumb { display: none !important; }
        .summary-card { 
            break-inside: avoid;
            page-break-inside: avoid;
        }
    }
</style>